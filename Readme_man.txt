===============================================================================

　ファイル暗号化プログラム（コマンドライン版）

===============================================================================


■ソフトの概要

　ファイルを暗号化・復号するコンソールアプリケーションです。


■動作環境

　Windows 10
　確認していませんが Windows 7/8/8.1 でも動くかもしれません。


■インストール方法

　アーカイブの中身をローカルディスク上の任意の場所にコピーして下さい。


■アンインストール方法

　レジストリなどは一切使っていません。
　ファイルを削除するだけでアンインストールできます。


■実行方法

　fCipher.exe [/B] [/S] [/R] [/E | /D] /P PASS-PHRASE [/PE X-CHR X-EXP] INPUT-FILE [OUTPUT-FILE]

　　/B          ... バッチモード
　　/S          ... サイレントモード
　　/R          ... 入力ファイルを削除する ※1
　　/E          ... 暗号化モード
　　/D          ... 復号モード
　　PASS-PHRASE ... パスフレーズ
　　INPUT-FILE  ... 入力ファイル
　　OUTPUT-FILE ... 出力ファイル
　　X-CHR       ... パスフレーズ延長文字
　　X-EXP       ... パスフレーズ延長スケール

　　復号に失敗すると出力ファイルは常に削除します。
　　/B /S /R /E /D /P /PE オプションは順序を入れ替えても問題ありません。(/P と PASS-PHRASE はセットです)


　●バッチモード

　　メッセージボックスの表示を抑止し、問い合わせや入力待ちを行わないようにします。


　●サイレントモード

　　標準出力を行わないようにします。


　●パスフレーズ

　　暗号化・復号に使用する共通鍵を指定します。
　　本プログラムが使用する鍵の長さは 512 ビットです。
　　128桁の16進数、つまり 0〜9, a〜f, A〜F の文字だけで構成された長さ128の文字列である場合、
　　そのまま鍵として使用します。
　　それ以外の場合、文字列の SHA-512 を鍵として使用します。
　　文字コードは CP932 です。

　　★パスフレーズが間違っているかファイルが破損していると、復号は失敗します。


　●パスフレーズの延長

　　/PE オプションを指定するとパスフレーズに [ランダムなバイト列_64バイト] + [ X-CHR を 2^(X-EXP) 個] を追加します。
　　これにより、非常に長いパスフレーズを使用することができます。
　　例えば、/P ABCDEF を指定した場合のパスフレーズは

　　　ABCDEF

　　ですが、/P ABCDEF /PE x 30 を指定した場合のパスフレーズは

　　　ABCDEF??????????...??????????xxxxxxxxxx...xxxxxxxxxx
　　　      |<---- 64 バイト ---->||<--- 2^30 バイト --->|

　　　　? ＝ 0 〜 255 の乱数 ※2

　　になります。
　　復号時もパスワードと同様に(暗号化時に指定したものと同じ) X-CHR, X-EXP を指定する必要があります。

　　X-CHR には1バイトの文字のみ指定できます。
　　2桁の16進数(0〜9, a〜f, A〜F の文字だけで構成された長さ2の文字列)は、文字コードとして処理します。
　　例えば、/PE _ 20 と /PE 5f 20 は同じです。

　　X-EXP に指定できる値は 10〜40 です。

　　X-EXP が十分に大きければ鍵の生成に時間が掛かるため、
　　総当り攻撃によるパスフレーズの推定は難しくなる・・・ような気がします。
　　(暗号理論的に効果があるかは分かりません・・・)


　●出力ファイルを省略した場合

　　暗号化モードであれば、入力ファイルに .cphr を付加した名前になります。
　　復号モードであれば、入力ファイルの拡張子を取り除いた名前になり、拡張子が無ければ .dec を付加します。


　●暗号化・復号モードを省略した場合

　　入力ファイルの拡張子が .cphr である場合、復号モードに、
　　それ以外は暗号化モードになります。


　●実行例

　　fCipher.exe /E /P 花鳥風月 C:\Data\Plain.txt C:\tmp\Cipher.enc

　　　... 入力ファイル "C:\Data\Plain.txt" をパスフレーズ "花鳥風月" で暗号化して "C:\tmp\Cipher.enc" に出力する。

　　fCipher.exe /D /P 東北自動車道 Encrypt.bin sub\Decrypt.bin

　　　... 入力ファイル ".\Encrypt.bin" をパスフレーズ "東北自動車道" で復号して ".\sub\Decrypt.bin" に出力する。

　　fCipher.exe /P 風花雪月 123.dat

　　　... 入力ファイル ".\123.dat" をパスフレーズ "風花雪月" で暗号化して ".\123.dat.cphr" に出力する。

　　fCipher.exe /P 紅孔雀 ..\ABC.txt.cphr

　　　... 入力ファイル "..\ABC.txt.cphr" をパスフレーズ "紅孔雀" で復号して "..\ABC.txt" に出力する。

　　fCipher.exe /B /S /P "harvest time" takami.slot dai3.gen

　　　... バッチモード＆サイレントモードで、入力ファイル ".\takami.slot" をパスフレーズ "harvest time" で暗号化して ".\dai3.gen" に出力する。

　　fCipher.exe /E /P あいうえお /PE x 30 aiueo.in aiueo.out

　　　... 入力ファイル ".\aiueo.in" をパスフレーズ "あいうえお" + ( 乱数バイト × 64 ) + ( "x" × 2^30 ) で暗号化して ".\aiueo.out" に出力する。

　　fCipher.exe /D /P あいうえお /PE x 30 aiueo.out aiueo.in-dec

　　　... 上で暗号化した ".\aiueo.out" を復号して ".\aiueo.in-dec" に出力する。

　　　　　★/PE オプションで暗号化したファイルを復号する時は /PE オプションを指定する必要があります。
　　　　　　暗号化時に指定したものと同じ X-CHR, X-EXT でなければなりません。

　　fCipher.exe /E /P 6ac43722c0d920d852e69ac6552caf1602852b74cbd63dcce7d9ba4f79e6038dcc68169d882f96bcd2fb452c1e4b1f0f9e6e61aece605a8cd5c173c7bba329fb Plain.dat

　　　... 入力ファイル ".\Plain.dat" を、指定された512ビットの鍵で暗号化して ".\Plain.dat.cphr" に出力する。


■パスフレーズ・鍵の生成

　以下のコマンドを実行すると、ランダムなパスフレーズを標準出力します。※2

　　fCipher.exe /MP [P-LEN]

　　　P-LEN ... パスフレーズの文字数, デフォルトは 22 文字, 指定できる範囲は 3 〜 1000

　　　パスフレーズは以下の文字グループから構成され、それぞれ 1 文字以上出現するようにします。
　　　・半角英大文字
　　　・半角英小文字
　　　・半角数字


　以下のコマンドを実行すると、ランダムな鍵を標準出力します。※2

　　fCipher.exe /MK


　●実行例

　　fCipher.exe /MP

　　fCipher.exe /MP 10

　　fCipher.exe /MK


■暗号化の実装

　CIPHER = cbcx ( cbcx ( PLAIN + padding + randpart + hash + iv , key1 ) , key2 )

　　padding  ... n を n 個並べたバイト列, n は PLAIN + padding のバイト数が16の倍数となるようなゼロではない8ビットの乱数 ※2
　　randpart ... 512ビットの乱数 (64バイト) ※2
　　hash     ... PLAIN + padding + randpart の SHA-512 (64バイト) ※3
　　iv       ... 128ビットの乱数 (16バイト) ※2
　　key1     ... 鍵の前半256ビット
　　key2     ... 鍵の後半256ビット
　　cbcx     ... 鍵長256ビットのcamelliaによる暗号化, 最後のブロックをIVとするCBCモード ※4

　　/PE オプションを指定した場合「ランダムなバイト列_64バイト」がファイルの終端に追加されます。


■取り扱い種別

　フリーソフト


■作者への連絡先

　stackprobes@gmail.com

　バグや要望などご連絡ください。


■注釈

　　※1 このオプションを指定して復号に失敗すると、入力・出力ファイル共に削除されることに注意して下さい。
　　※2 乱数は CSPRNG (CryptGenRandom) から取得します。
　　※3 復号時 hash が一致しなければ、鍵の不一致かファイルの破損(改ざん)と見なします。
　　※4 例えば P1 + P2 + P3 を暗号化した C1 + C2 + C3 は以下のとおりになります。(Px,Cx はそれぞれ1ブロック)
　　　　C1 = encrypt ( xor ( P1 , P3 ) )
　　　　C2 = encrypt ( xor ( P2 , C1 ) )
　　　　C3 = encrypt ( xor ( P3 , C2 ) )

